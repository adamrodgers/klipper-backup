# ==================== CHAMBER TEMPERATURE CONTROL ====================
# ==================== macros/chamber.cfg ====================
# Chamber heating, temperature control, and heat soak operations (no thermistor required)

[gcode_macro M141]
description: Set chamber temperature (disabled - no thermistor)
gcode:
    {% set target_temp = params.S|default(0)|float %}
    SET_GCODE_VARIABLE MACRO=_CHAMBER_CONTROL VARIABLE=target_temp VALUE={target_temp}
    {% if target_temp == 0 %}
        _LOG_STATUS MSG="Chamber heating disabled (no thermistor)"
    {% else %}
        _LOG_STATUS MSG="Chamber target set to {target_temp}°C (timer-based heating only)"
    {% endif %}

[gcode_macro M191]
description: Wait for chamber temperature (timer-based without thermistor)
gcode:
    {% set target_temp = params.S|default(0)|float %}
    {% if target_temp == 0 %}
        _LOG_STATUS MSG="Chamber heating disabled" LED=ready
    {% else %}
        # Use timer-based heating since no thermistor available
        status_heating
        _LOG_STATUS MSG="Timer-based chamber conditioning for {target_temp}°C target"
        
        _CHAMBER_HEAT_AND_WAIT TARGET={target_temp}
        
        status_ready
        _LOG_STATUS MSG="Chamber conditioning completed"
    {% endif %}

[gcode_macro _CHAMBER_CONTROL]
description: Chamber control state variable
variable_target_temp: 0
gcode:

[gcode_macro _CHAMBER_HEAT_AND_WAIT]
description: Timer-based chamber heating without thermistor
gcode:
    {% set target_temp = params.TARGET|float %}
    
    # Set bed to 100°C for chamber heating (or current target if higher)
    {% set chamber_bed_temp = [printer.heater_bed.target, 100]|max %}
    M140 S{chamber_bed_temp}
    
    # Timer-based heating - estimate time based on target temperature
    {% if target_temp >= 40 %}
        {% set heat_time = 20 %}  # 20 minutes for high temps
    {% elif target_temp >= 30 %}
        {% set heat_time = 3%}  # 15 minutes for medium temps
    {% else %}
        {% set heat_time = 10 %}  # 10 minutes for low temps
    {% endif %}
    
    _LOG_STATUS MSG="Timer-based heating: {heat_time} minutes for {target_temp}°C target"
    
    # Progress reporting during heating
    {% for minute in range(1, heat_time + 1) %}
        _LOG_STATUS MSG="Chamber heating: {minute}/{heat_time} minutes"
        G4 P60000  # Wait 1 minute
    {% endfor %}

[gcode_macro _HEAT_SOAK_CHAMBER]
description: Material-specific heat soak without chamber thermistor
gcode:
    {% set bedtemp = params.BED_TEMP|int %}
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set chamber_target = params.CHAMBER|float %}
    {% set heatsoak_time = printer['gcode_macro _global_var'].heat_soak_time|default(3)|int %}
    
    {% if material == "PLA" %}
        # PLA: Simple heat soak, no chamber heating
        status_heating
        _LOG_STATUS MSG="{material} heat soak ({heatsoak_time} min) - no chamber heating"
        G4 P{heatsoak_time * 60 * 1000}
        status_ready
        
    {% elif chamber_target == 0 %}
        # Material with no chamber requirement
        _LOG_STATUS MSG="{material} printing - no chamber heating required" LED=ready
        
    {% else %}
        # Timer-based chamber conditioning for materials requiring chamber heat
        {% set chamber_bed_temp = [bedtemp, 100]|max %}
        M140 S{chamber_bed_temp}
        
        status_heating
        _LOG_STATUS MSG="Timer-based {material} chamber conditioning ({chamber_target}°C target)"
        
        # Use timer-based heating
        _CHAMBER_HEAT_AND_WAIT TARGET={chamber_target}
        
        status_ready
        _LOG_STATUS MSG="Chamber conditioning completed for {material}"
    {% endif %}