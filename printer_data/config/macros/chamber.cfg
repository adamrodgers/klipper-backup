# ==================== CHAMBER TEMPERATURE CONTROL ====================
# Chamber heating, temperature control, and heat soak operations

[gcode_macro M141]
description: Set chamber temperature
gcode:
    {% set target_temp = params.S|default(0)|float %}
    SET_GCODE_VARIABLE MACRO=_CHAMBER_CONTROL VARIABLE=target_temp VALUE={target_temp}
    {% if target_temp == 0 %}
        _LOG_STATUS MSG="Chamber heating disabled"
    {% else %}
        _LOG_STATUS MSG="Chamber target temperature set to {target_temp}°C"
    {% endif %}

[gcode_macro M191]
description: Wait for chamber temperature with pulsing
gcode:
    {% set target_temp = params.S|default(0)|float %}
    {% if target_temp == 0 %}
        _LOG_STATUS MSG="Chamber heating disabled" LED=ready
        _CHAMBER_PULSE ACTION=stop
    {% else %}
        {% set current_temp = printer["temperature_sensor chamber"].temperature %}
        
        {% if target_temp <= current_temp %}
            _LOG_STATUS MSG="Chamber already at or above target ({current_temp|round(1)}°C ≥ {target_temp}°C)" LED=ready
        {% else %}
            {% set current_bed_target = printer.heater_bed.target %}
            {% set bed_temp_for_chamber = 85 %}
            
            {% if current_bed_target > 70 %}
                {% set bed_temp_for_chamber = [current_bed_target, 100]|min %}
            {% elif target_temp >= 35 %}
                {% set bed_temp_for_chamber = 100 %}
            {% elif target_temp >= 30 %}
                {% set bed_temp_for_chamber = 85 %}
            {% endif %}
            
            _LOG_STATUS MSG="Waiting for chamber to reach {target_temp}°C" LED=heating
            _CHAMBER_PULSE ACTION=start
            _CHAMBER_HEAT_AND_WAIT TARGET={target_temp} BED_TEMP={bed_temp_for_chamber}
            _CHAMBER_PULSE ACTION=stop
            _LOG_STATUS MSG="Chamber reached target temperature" LED=ready
        {% endif %}
    {% endif %}

[gcode_macro _CHAMBER_CONTROL]
description: Chamber control state variable
variable_target_temp: 0
gcode:

[gcode_macro _CHAMBER_HEAT_AND_WAIT]
description: Chamber heating (called by M191)
gcode:
    {% set target_temp = params.TARGET|float %}
    {% set bed_temp = params.BED_TEMP|default(85)|int %}
    {% set current_temp = printer["temperature_sensor chamber"].temperature %}
    
    M140 S{bed_temp}
    
    {% set temp_diff = target_temp - current_temp %}
    {% if temp_diff > 10 %}
        {% set progress_interval = 5 %}
        {% set next_milestone = (current_temp + progress_interval)|round(0) %}
        
        {% for milestone in range(next_milestone|int, target_temp|int, progress_interval) %}
            _LOG_STATUS MSG="Chamber heating: {milestone}°C / {target_temp}°C"
            TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={milestone}
        {% endfor %}
    {% endif %}
    
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_temp}

[gcode_macro _CHAMBER_PULSE]
description: Chamber heating pulse control with multiple steps using LED status system
variable_active: False
variable_step: 0
gcode:
    {% set action = params.ACTION|default("toggle")|string %}
    
    {% if action == "start" %}
        SET_GCODE_VARIABLE MACRO=_CHAMBER_PULSE VARIABLE=active VALUE=True
        SET_GCODE_VARIABLE MACRO=_CHAMBER_PULSE VARIABLE=step VALUE=0
        _set_hotend_led_by_name COLOR=chamber_heating_dim
        UPDATE_DELAYED_GCODE ID=chamber_pulse_timer DURATION=0.3
    {% elif action == "stop" %}
        SET_GCODE_VARIABLE MACRO=_CHAMBER_PULSE VARIABLE=active VALUE=False
        UPDATE_DELAYED_GCODE ID=chamber_pulse_timer DURATION=0
        _set_hotend_led_by_name COLOR=heating
    {% elif action == "toggle" %}
        {% set current_step = printer["gcode_macro _CHAMBER_PULSE"].step|int %}
        
        {% if current_step % 2 == 0 %}
            _set_hotend_led_by_name COLOR=chamber_heating_bright
        {% else %}
            _set_hotend_led_by_name COLOR=chamber_heating_dim
        {% endif %}
        
        {% if current_step >= 7 %}
            SET_GCODE_VARIABLE MACRO=_CHAMBER_PULSE VARIABLE=step VALUE=0
        {% else %}
            SET_GCODE_VARIABLE MACRO=_CHAMBER_PULSE VARIABLE=step VALUE={current_step + 1}
        {% endif %}
        
        UPDATE_DELAYED_GCODE ID=chamber_pulse_timer DURATION=0.3
    {% endif %}

[delayed_gcode chamber_pulse_timer]
initial_duration: 0
gcode:
    {% if printer["gcode_macro _CHAMBER_PULSE"].active %}
        _CHAMBER_PULSE ACTION=toggle
    {% endif %}

[gcode_macro _HEAT_SOAK_CHAMBER]
description: Heat soak with optional chamber pulsing and minimum soak times
gcode:
    {% set bedtemp = params.BED_TEMP|int %}
    {% set heatsoak_time = printer['gcode_macro _global_var'].heat_soak_time|default(3)|int %}
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set filament_temps = printer['gcode_macro _global_var'].filament_chamber_temps %}
    
    {% set orcaslicer_chamber_target = printer['gcode_macro _CHAMBER_CONTROL'].target_temp|default(0)|float %}
    {% set chamber_target = params.CHAMBER|default(orcaslicer_chamber_target)|int %}
    
    {% if chamber_target == 0 %}
        {% set chamber_target = filament_temps[material]|default(0) %}
    {% endif %}
    
    {% set current_chamber_temp = printer["temperature_sensor chamber"].temperature %}
    
    {% set material_soak_times = {
        "PLA": 3,
        "PETG": 4,
        "ASA": 3,
        "ABS": 3,
        "TPU": 3,
        "ASA-AERO": 3,
        "HIPS": 4
    } %}
    {% set min_soak_time = material_soak_times[material]|default(3) %}
    
    {% if material == "PLA" %}
        _LOG_STATUS MSG="{material} printing - performing {min_soak_time} minute heat soak (no chamber heating)" LED=heating
        G4 P{min_soak_time * 60 * 1000}
        _LOG_STATUS MSG="{material} heat soak completed" LED=ready
        M104 S150
    {% elif chamber_target == 0 %}
        _LOG_STATUS MSG="{material} printing - no heat soak required (chamber heating will handle timing)" LED=ready
    {% else %}
        {% if current_chamber_temp >= chamber_target %}
            _LOG_STATUS MSG="Chamber already at {current_chamber_temp|round(1)}°C (target: {chamber_target}°C) - performing {min_soak_time} minute {material} soak" LED=heating
            G4 P{min_soak_time * 60 * 1000}
            _LOG_STATUS MSG="{material} heat soak completed" LED=ready
        {% else %}
            {% set start_time = printer.system_stats.cputime %}
            
            _LOG_STATUS MSG="Heating chamber from {current_chamber_temp|round(1)}°C to {chamber_target}°C for {material}" LED=heating
            _CHAMBER_PULSE ACTION=start
            
            {% set chamber_bed_temp = [bedtemp, 100]|min %}
            M140 S{chamber_bed_temp}
            
            TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={chamber_target}
            
            _CHAMBER_PULSE ACTION=stop
            
            {% set heating_duration = (printer.system_stats.cputime - start_time) / 60 %}
            {% if heating_duration >= min_soak_time %}
                _LOG_STATUS MSG="Chamber heating ({heating_duration|round(1)} min) completed - minimum soak time satisfied" LED=ready
            {% else %}
                {% set remaining_soak = (min_soak_time - heating_duration) * 60 %}
                _LOG_STATUS MSG="Additional {(remaining_soak/60)|round(1)} min soak required for {material}" LED=heating
                G4 P{remaining_soak * 1000}
                _LOG_STATUS MSG="Chamber heating and {material} heat soak completed" LED=ready
            {% endif %}
        {% endif %}
    {% endif %}