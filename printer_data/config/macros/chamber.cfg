# ==================== CHAMBER TEMPERATURE CONTROL ====================
# ==================== macros/chamber.cfg ====================
# Chamber heating, temperature control, and heat soak operations with enhanced LED pulsing

[gcode_macro M141]
description: Set chamber temperature
gcode:
    {% set target_temp = params.S|default(0)|float %}
    SET_GCODE_VARIABLE MACRO=_CHAMBER_CONTROL VARIABLE=target_temp VALUE={target_temp}
    {% if target_temp == 0 %}
        _LOG_STATUS MSG="Chamber heating disabled"
    {% else %}
        _LOG_STATUS MSG="Chamber target temperature set to {target_temp}°C"
    {% endif %}

[gcode_macro M191]
description: Wait for chamber temperature with pulsing
gcode:
    {% set target_temp = params.S|default(0)|float %}
    {% if target_temp == 0 %}
        _LOG_STATUS MSG="Chamber heating disabled" LED=ready
        _HEAT_SOAK_PULSE ACTION=stop
    {% else %}
        {% set current_temp = printer["temperature_sensor chamber"].temperature %}
        
        {% if target_temp <= current_temp %}
            _LOG_STATUS MSG="Chamber already at or above target ({current_temp|round(1)}°C ≥ {target_temp}°C)" LED=ready
        {% else %}
            {% set current_bed_target = printer.heater_bed.target %}
            {% set bed_temp_for_chamber = 85 %}
            
            {% if current_bed_target > 70 %}
                {% set bed_temp_for_chamber = [current_bed_target, 100]|min %}
            {% elif target_temp >= 35 %}
                {% set bed_temp_for_chamber = 100 %}
            {% elif target_temp >= 30 %}
                {% set bed_temp_for_chamber = 85 %}
            {% endif %}
            
            _LOG_STATUS MSG="Waiting for chamber to reach {target_temp}°C" LED=heating
            _HEAT_SOAK_PULSE ACTION=start TYPE=chamber
            _CHAMBER_HEAT_AND_WAIT TARGET={target_temp} BED_TEMP={bed_temp_for_chamber}
            _HEAT_SOAK_PULSE ACTION=stop
            _LOG_STATUS MSG="Chamber reached target temperature" LED=ready
        {% endif %}
    {% endif %}

[gcode_macro _CHAMBER_CONTROL]
description: Chamber control state variable
variable_target_temp: 0
gcode:

[gcode_macro _CHAMBER_HEAT_AND_WAIT]
description: Chamber heating (called by M191)
gcode:
    {% set target_temp = params.TARGET|float %}
    {% set bed_temp = params.BED_TEMP|default(85)|int %}
    {% set current_temp = printer["temperature_sensor chamber"].temperature %}
    
    M140 S{bed_temp}
    
    {% set temp_diff = target_temp - current_temp %}
    {% if temp_diff > 10 %}
        {% set progress_interval = 5 %}
        {% set next_milestone = (current_temp + progress_interval)|round(0) %}
        
        {% for milestone in range(next_milestone|int, target_temp|int, progress_interval) %}
            _LOG_STATUS MSG="Chamber heating: {milestone}°C / {target_temp}°C"
            TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={milestone}
        {% endfor %}
    {% endif %}
    
    TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_temp}

[gcode_macro _HEAT_SOAK_PULSE]
description: Universal heat soak pulse control for all soak types
variable_active: False
variable_step: 0
variable_type: "chamber"
gcode:
    {% set action = params.ACTION|default("toggle")|string %}
    {% set pulse_type = params.TYPE|default("chamber")|string %}
    
    {% if action == "start" %}
        SET_GCODE_VARIABLE MACRO=_HEAT_SOAK_PULSE VARIABLE=active VALUE=True
        SET_GCODE_VARIABLE MACRO=_HEAT_SOAK_PULSE VARIABLE=step VALUE=0
        SET_GCODE_VARIABLE MACRO=_HEAT_SOAK_PULSE VARIABLE=type VALUE='"{pulse_type}"'
        
        {% if pulse_type == "chamber" %}
            _set_hotend_led_by_name COLOR=chamber_heating_dim
        {% elif pulse_type == "pla_soak" %}
            _set_hotend_led_by_name COLOR=ready
        {% elif pulse_type == "material_soak" %}
            _set_hotend_led_by_name COLOR=heating
        {% endif %}
        
        UPDATE_DELAYED_GCODE ID=heat_soak_pulse_timer DURATION=0.4
        
    {% elif action == "stop" %}
        SET_GCODE_VARIABLE MACRO=_HEAT_SOAK_PULSE VARIABLE=active VALUE=False
        UPDATE_DELAYED_GCODE ID=heat_soak_pulse_timer DURATION=0
        
    {% elif action == "toggle" %}
        {% set current_step = printer["gcode_macro _HEAT_SOAK_PULSE"].step|int %}
        {% set current_type = printer["gcode_macro _HEAT_SOAK_PULSE"].type|string %}
        
        {% if current_type == "chamber" %}
            {% if current_step % 2 == 0 %}
                _set_hotend_led_by_name COLOR=chamber_heating_bright
            {% else %}
                _set_hotend_led_by_name COLOR=chamber_heating_dim
            {% endif %}
        {% elif current_type == "pla_soak" %}
            {% if current_step % 2 == 0 %}
                _set_hotend_led_by_name COLOR=meshing
            {% else %}
                _set_hotend_led_by_name COLOR=ready
            {% endif %}
        {% elif current_type == "material_soak" %}
            {% if current_step % 2 == 0 %}
                _set_hotend_led_by_name COLOR=leveling
            {% else %}
                _set_hotend_led_by_name COLOR=heating
            {% endif %}
        {% endif %}
        
        {% if current_step >= 9 %}
            SET_GCODE_VARIABLE MACRO=_HEAT_SOAK_PULSE VARIABLE=step VALUE=0
        {% else %}
            SET_GCODE_VARIABLE MACRO=_HEAT_SOAK_PULSE VARIABLE=step VALUE={current_step + 1}
        {% endif %}
        
        UPDATE_DELAYED_GCODE ID=heat_soak_pulse_timer DURATION=0.4
    {% endif %}

[delayed_gcode heat_soak_pulse_timer]
initial_duration: 0
gcode:
    {% if printer["gcode_macro _HEAT_SOAK_PULSE"].active %}
        _HEAT_SOAK_PULSE ACTION=toggle
    {% endif %}

[gcode_macro _HEAT_SOAK_CHAMBER]
description: Heat soak with material-based chamber control (no M141 dependency)
gcode:
    {% set bedtemp = params.BED_TEMP|int %}
    {% set heatsoak_time = printer['gcode_macro _global_var'].heat_soak_time|default(3)|int %}
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set chamber_target = params.CHAMBER|float %}
    
    {% set current_chamber_temp = printer["temperature_sensor chamber"].temperature %}
    
    {% set material_soak_times = {
        "PLA": 3,
        "PETG": 4,
        "ASA": 3,
        "ABS": 3,
        "TPU": 3,
        "ASA-AERO": 3,
        "HIPS": 4
    } %}
    {% set min_soak_time = material_soak_times[material]|default(3) %}
    
    {% if material == "PLA" or material == "PETG" %}
        _LOG_STATUS MSG="{material} printing - performing {min_soak_time} minute heat soak (no chamber heating)" LED=heating
        _HEAT_SOAK_PULSE ACTION=start TYPE=pla_soak
        G4 P{min_soak_time * 60 * 1000}
        _HEAT_SOAK_PULSE ACTION=stop
        _LOG_STATUS MSG="{material} heat soak completed" LED=ready
        M104 S150
        
    {% elif chamber_target == 0 %}
        _LOG_STATUS MSG="{material} printing - no chamber heating required" LED=ready
        
    {% else %}
        {% if current_chamber_temp >= chamber_target %}
            _LOG_STATUS MSG="Chamber already at {current_chamber_temp|round(1)}°C (target: {chamber_target}°C) - performing {min_soak_time} minute {material} soak" LED=heating
            _HEAT_SOAK_PULSE ACTION=start TYPE=material_soak
            G4 P{min_soak_time * 60 * 1000}
            _HEAT_SOAK_PULSE ACTION=stop
            _LOG_STATUS MSG="{material} heat soak completed" LED=ready
            
        {% else %}
            {% set start_time = printer.system_stats.cputime %}
            
            _LOG_STATUS MSG="Heating chamber from {current_chamber_temp|round(1)}°C to {chamber_target}°C for {material}" LED=heating
            _HEAT_SOAK_PULSE ACTION=start TYPE=chamber
            
            {% set chamber_bed_temp = [bedtemp, 100]|min %}
            M140 S{chamber_bed_temp}
            
            # Start nevermore fans at chamber heating speed
            {% set nevermore_chamber_speed = printer['gcode_macro _NEVERMORE_VARS'].slow|float %}
            SET_FAN_SPEED FAN=nevermore_fans SPEED={nevermore_chamber_speed}
            _LOG_STATUS MSG="Nevermore fans set to {(nevermore_chamber_speed * 100)|round(0)}% for chamber heating"
            
            TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={chamber_target}
            
            {% set heating_duration = (printer.system_stats.cputime - start_time) / 60 %}
            {% if heating_duration >= min_soak_time %}
                _HEAT_SOAK_PULSE ACTION=stop
                _LOG_STATUS MSG="Chamber heating ({heating_duration|round(1)} min) completed - minimum soak time satisfied" LED=ready
            {% else %}
                {% set remaining_soak = (min_soak_time - heating_duration) * 60 %}
                _LOG_STATUS MSG="Additional {(remaining_soak/60)|round(1)} min soak required for {material}" LED=heating
                SET_GCODE_VARIABLE MACRO=_HEAT_SOAK_PULSE VARIABLE=type VALUE='"material_soak"'
                G4 P{remaining_soak * 1000}
                _HEAT_SOAK_PULSE ACTION=stop
                _LOG_STATUS MSG="Chamber heating and {material} heat soak completed" LED=ready
            {% endif %}
            
            # Set nevermore to print speed only for materials that need it
            {% if material not in ["PLA", "PETG"] %}
                {% set nevermore_print_speed = printer['gcode_macro _NEVERMORE_VARS'].fast|float %}
                SET_FAN_SPEED FAN=nevermore_fans SPEED={nevermore_print_speed}
                _LOG_STATUS MSG="Nevermore fans set to {(nevermore_print_speed * 100)|round(0)}% for {material} printing"
            {% else %}
                SET_FAN_SPEED FAN=nevermore_fans SPEED=0
                _LOG_STATUS MSG="Nevermore fans off for {material} printing"
            {% endif %}
        {% endif %}
    {% endif %}